# 基于加密与区块链结构的二手书交易平台

## 开发规范文档（v1）

> 
> 
> 目标：
> 
> - 不依赖传统区块链网络（无 P2P / 无共识）
>     
> - 使用经典 前端–后端–数据库 架构
>     
> - 通过**密码学 + 区块链数据结构**实现：
>     
>     - 交易不可伪造
>         
>     - 聊天内容服务器不可知
>         
>     - 用户无需注册账号，仅以密钥为身份
>         
> 
> 

---

## 1. 总体设计原则

### 1.1 若无必要，勿增实体

- 不引入智能合约等复杂状态机
    
- 不引入 P2P 网络
    
- 不引入代币 / 经济激励
    
- 不做去中心化身份系统（DID）
    

我们只解决一个问题：

> **在中心化服务器上，用密码学手段实现“不可抵赖的交易记录 + 私密聊天”。**

---

## 2. 系统总体架构

### 2.1 架构概览

```
浏览器（HTML + JS）
    │
    │ HTTPS / WebSocket
    ▼
Python 后端（API + Service）
    │
    ▼
MySQL（明文索引 + 密文存储）
    │
    ▼
区块链数据结构（Append-only）
```

### 2.2 各层职责边界（红线）

|层级|允许做的事|禁止做的事|
|---|---|---|
|前端|生成密钥、签名、加密、解密、展示|判断交易合法性、改状态|
|后端 API|接收请求、参数校验|生成签名、解密聊天|
|Service|验签、状态机、写链|处理 UI、直接接 HTTP|
|数据库|存储|生成业务含义|

---

## 3. 身份与密钥体系

### 3.1 用户身份模型

- **无账号、无注册**
    
- 用户身份 = 一对长期密钥
    

```
IdentityKeyPair = {
  publicKey: Ed25519_PK,
  privateKey: Ed25519_SK
}
```

- 私钥：
    
    - 仅存在客户端（localStorage / IndexedDB）
        
    - 永不上传服务器
        
- 公钥：
    
    - 作为用户唯一身份
        
    - 写入交易与区块
        

### 3.2 用户个人信息

- 用户信息 = **私钥签名的声明**
    

- 特点：
    
    - 只能由私钥持有者生成
        
    - 服务器可验证但不可伪造
        

---

## 4. 交易系统设计

### 4.1 交易目标

- 一个交易 = 一个独立状态机
    
- 所有状态变化 = **写新区块**
    
- 绝不修改历史
    

### 4.2 交易状态机

```
OPEN ──► COMPLETED
  │
  └──► CANCELLED
```

- 只有卖家可以取消
    
- 完成必须双方签名
    

### 4.3 交易核心数据结构

```
TradeContent = {
  description,   // 书名、版本、备注
  price,
  extra
}
```

```
CreateTradeBody = {
  trade_id,
  seller_pubkey,
  content_hash,
  timestamp
}
```

```
CompleteTradeBody = {
  trade_id,
  result: "COMPLETED",
  timestamp
}
```

```
CancelTradeBody = {
  trade_id,
  result: "CANCELLED",
  timestamp
}
```

### 4.4 交易签名规则

- 所有签名对象 = **hash 后再签名**
    
- 禁止直接签 JSON
    

```
trade_hash = SHA256(canonical_json(body))
signature = Sign(trade_hash, privateKey)
```

---

## 5. 区块链结构（服务器本地）

### 5.1 区块定义

```
Block = {
  index,
  prev_hash,
  timestamp,
  type,           // CREATE / COMPLETE / CANCEL
  payload,
  signatures,
  block_hash
}
```

- payload 为原始交易事件
    
- block_hash = hash(除自身外所有字段)
    

### 5.2 区块规则

- 只能 append
    
- 不允许 delete / update
    
- 服务器只验证，不创造语义
    

---

## 6. 聊天系统设计

### 6.1 设计目标

- 服务器不可读聊天内容
    
- 任一私钥可解密完整聊天
    
- 聊天仅在交易生命周期内存在
    

### 6.2 密钥协商

- 使用 ECDH（X25519）
    

```
shared = ECDH(mySK, peerPK)
chatKey = HKDF(shared, trade_id)
```

### 6.3 加密算法

- AES-256-GCM
    

```
ChatMessage = AES(chatKey, {
  trade_id,
  sender_pubkey,
  timestamp,
  message
})
```

### 6.4 服务器角色

- WebSocket 中转
    
- 不解密
    
- 不缓存明文
    

---

## 7. 前端模块规范

### 7.1 crypto.js

职责：

- 密钥生成
    
- Hash / Sign / Verify
    
- ECDH / AES
    

禁止：

- 网络请求
    
- 状态存储
    

### 7.2 api.js

职责：

- HTTP / WS 通信
    

禁止：

- 加密
    
- 业务判断
    

### 7.3 trade.js

职责：

- 交易流程编排
    

### 7.4 chat.js

职责：

- 聊天会话管理
    

---

## 8. 后端模块规范

### 8.1 api 层

- 只做参数校验
    
- 不写业务逻辑
    

### 8.2 service 层

- 验签
    
- 状态机
    
- 写区块
    

### 8.3 blockchain 层

- 维护 hash 链
    

---

## 9. 数据库规范

### 9.1 表职责

- trades：当前状态快照
    
- blocks：不可变账本
    
- chats：密文缓存（可清理）
    

### 9.2 数据一致性

- 数据库状态必须可由区块链重建
    

---

## 10. 安全与威胁模型

###  能防御

- 服务器伪造交易（密钥即身份）
    
- 篡改历史（区块链可导出验证）
    
- 偷看聊天（服务器只存密文）
    


## 11. 结语

本项目不是“真正的区块链”，  
但它是：

> **去身份化，中心半可信交易系统。**



